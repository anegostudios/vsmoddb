"use strict";var R={get:e=>document.getElementById(e),getQ:e=>document.querySelector(e),make:function(e,...t){const[n,...o]=e.split("."),i=document.createElement(n);return o&&i.classList.add(...o),t&&i.append(...t),i},formatByteSize:function(e){return e>1073741824?(e/1073741824).toFixed(2)+" GB":e>1048576?(e/1048576).toFixed(2)+" MB":e>1024?(e/1024).toFixed(2)+" KB":e+" B"},onDOMLoaded:function(e){"loading"!==document.readyState?e():document.addEventListener("DOMContentLoaded",e)},msgContainer:null,addMessage:function(e,t,n){n=n||!0;const o=R.make("div."+e);n?(o.textContent=t,o.append(R.make("span.dismiss"))):o.innerHTML=t+'<span class="dismiss"></span>',R.msgContainer.append(o)},markAsErrorElement:function(e){e.classList.add("invalid"),setTimeout(()=>e.classList.remove("invalid"),500)},attachDefaultFailHandler:function(e,t="Request failed"){return e.fail(e=>{let n;try{n=JSON.parse(e.responseText)}catch{R.addMessage(MSG_CLASS_ERROR,"Failed to parse response.",!1),n={reason:e.responseText}}R.addMessage(MSG_CLASS_ERROR,t+(n.reason?": "+n.reason:"."),!0)})},trimLeadingEmptyLines:function(e){let t=e.firstChild;for(;t;)"BR"===t.nodeName||["P","DIV"].includes(t.nodeName)&&!t.textContent?t.remove():e=t,t=e.firstChild},trimTrailingEmptyLines:function(e){let t=e.lastChild;for(;t;)"BR"===t.nodeName||["P","DIV"].includes(t.nodeName)&&!t.textContent?t.remove():e=t,t=e.lastChild}};R.msgContainer=R.get("message-container"),R.msgContainer.addEventListener("click",e=>{let t=e.target;t&&t.classList.contains("dismiss")&&(t=t.parentElement,$(t).slideUp(400,()=>t.remove()))});const MSG_CLASS_OK="bg-success.text-success",MSG_CLASS_WARN="bg-warning",MSG_CLASS_ERROR="bg-error.text-error";function attachUserSearchHandler(e){let t=null,n=null;const o=e.getElementsByClassName("chosen-search-input")[0],i=e.getElementsByTagName("select")[0],a=i.dataset.url;a?o.addEventListener("keydown",()=>{null!==t&&clearTimeout(t),n=t,t=setTimeout(()=>{const e=o.value;if(!e)return void(t=null);const r=n,s=a.replace("{name}",e);$.get(s,a=>{if(n!==r)return;if(!a)return void(t=null);const s=$(i).val();i.replaceChildren(...Array.from(i.querySelectorAll("option:checked")));for(const[e,t]of Object.entries(a)){if(null!=s&&s.includes(e))continue;const n=document.createElement("option");n.value=e,n.textContent=t,i.append(n)}const l=getComputedStyle(o).width;$(i).trigger("chosen:updated"),o.value=e,o.style.width=l,t=null})},500)}):console.warn("attachUserSearchHandler called on an element who's select does not have a url in its dataset.")}function attachDialogSendHandler(e,t,n){const o=e.getElementsByTagName("form");if(o.length<1)return void console.warn("Dialog is missing a form",e);const i=o[0];let a;for(const t of e.getElementsByTagName("button"))if("dialog"!==t.formMethod){a=t;break}a?a.addEventListener("click",()=>{const e=new FormData(i,a);if(!t(i,e))return;a.disabled=!0;const o=$.ajax(i.action,{method:i.dataset.method,processData:!1,contentType:!1,data:e});o.fail(()=>a.disabled=!1),n(o)}):console.warn("Dialog is missing a non closing (formmethod!=dialog) button",e)}function attachSpoilerToggle(e){e.click(function(){$(this).toggleClass("expanded")})}var tinymceSettings={plugins:"paste print preview searchreplace autolink autoresize directionality visualblocks visualchars fullscreen image link media code codesample table charmap hr pagebreak nonbreaking anchor toc insertdatetime emoticons advlist lists wordcount imagetools textpattern help spoiler mention noneditable",external_plugins:{mention:"/web/js/tinymce-custom/plugins/mention/plugin.min.js"},toolbar:"formatselect | bold italic strikethrough forecolor backcolor permanentpen formatpainter | link image media pageembed emoticons | alignleft aligncenter alignright alignjustify  | numlist bullist outdent indent | removeformat code | spoiler-add spoiler-remove",toolbar_sticky:!0,image_advtab:!0,importcss_append:!0,height:400,image_caption:!0,convert_urls:!0,relative_urls:!1,remove_script_host:!1,tinycomments_mode:"embedded",content_css:"/web/css/editor_content.css?ver=6",setup:function(e){e.on("change",function(e){tinyMCE.triggerSave(),$("#"+e.target.id).parents("form").trigger("checkform.areYouSure")}),e.on("keyup",function(e){tinyMCE.triggerSave(),$("#"+e.target.id).parents("form").trigger("checkform.areYouSure")})},paste_postprocess:function(e,t){maybePromptForRelativeLinkRemoval(t.node)},mentions:{source:function(e,t){e&&$.getJSON("/api/v2/users/by-name/"+encodeURIComponent(e),function(e){t(Object.entries(e))})},queryBy:1,insert:function(e){return`<a class="mention username mceNonEditable" data-user-hash="${e[0]}" href="/show/user/${e[0]}">${e[1]}</a>`}}},tinymceSettingsCmt={menubar:!1,plugins:"paste searchreplace autolink autoresize directionality image link codesample charmap hr pagebreak nonbreaking anchor emoticons advlist lists wordcount imagetools textpattern help spoiler mention noneditable",external_plugins:tinymceSettings.external_plugins,toolbar:"bold italic strikethrough | link image emoticons | alignleft aligncenter alignright alignjustify  | numlist bullist outdent indent | removeformat | spoiler-add spoiler-remove",toolbar_sticky:!0,image_advtab:!0,importcss_append:!0,min_height:400,height:400,image_caption:!0,convert_urls:!0,relative_urls:!1,remove_script_host:!1,tinycomments_mode:"embedded",paste_data_images:!0,content_css:tinymceSettings.content_css,setup:function(e){tinymceSettings.setup(e),e.on("SetContent",function(t){if(!t.initial&&t.paste&&wrapNextPaste){wrapNextPaste=0;const t=e.dom.select(".spoiler");e.selection.setNode(t[t.length-1]),e.selection.collapse(!1),e.focus()}})},paste_preprocess:function(e,t){const n=t.content;n&&(t.content=n.trim().replaceAll("\r\n","\n"),couldBeCrashReport(n)?confirm('Whoa there, looks like you pasted a crash report.\nShould we wrap that for you, so its easier to read for the Modder?\n\nPressing "cancel" (or the equivalent in your language) will paste the text as-is.')&&(wrapNextPaste=2):n.length>=1e3&&!n.includes("base64,")&&confirm('Whoa there, looks like you pasted a lot of text at once.\nShould we wrap that for you, so its easier to read for the Modder?\n\nPressing "cancel" (or the equivalent in your language) will paste the text as-is.')&&(wrapNextPaste=1))},paste_postprocess:function(e,t){if(R.trimLeadingEmptyLines(t.node),R.trimTrailingEmptyLines(t.node),wrapNextPaste){const e=wrapAsSpoilerForTMCE(t.node.childNodes,2===wrapNextPaste);t.node.replaceChildren(e)}maybePromptForRelativeLinkRemoval(t.node)},mentions:tinymceSettings.mentions};function maybePromptForRelativeLinkRemoval(e){const t=e.querySelectorAll('a[href^="./"], a[href^="../"], a[href^="/"][href*="/issues/"]');if(t.length){let e,n=t[0].getAttribute("href");try{e=new URL(n,document.baseURI).href}catch{e="<link was malformed>"}if(confirm(`Looks like there are relative links in that html you've just pasted in here - we found ${t.length} such link${1===t.length?"":"s"}.\nUnless you also copied it from here, those probably wont link to the page you want.\n\nHere is the first one and where it would link to:\n\t${t[0].textContent}\n\tlinks to '${n}',\n\twhich actually resolves to '${e}'\n\nSince we cannot determine where this was copied from, we cannot automatically fix the links for you - we can however at least remove them from the text.\nShould we do that?\n\nPressing "cancel" (or the equivalent in your language) will paste the text as-is.`))for(const e of t)e.parentElement.replaceChild(R.make("span",...e.childNodes),e)}}let wrapNextPaste=0;function couldBeCrashReport(e){return e.includes("System.Exception")||e.includes("at Vintagestory.")||e.includes("Event Log")||e.includes("Critical error")}function wrapAsSpoilerForTMCE(e,t){const n=R.make("div.spoiler-toggle",t?"Crash Report":"Spoiler");n.setAttribute("contenteditable","true");const o=R.make(t?"pre.spoiler-text":"div.spoiler-text");o.setAttribute("contenteditable","true");for(const t of e)t.style&&(t.style.whiteSpace="",t.style.font="");o.append(...e);const i=R.make("div.spoiler");return t&&i.classList.add("crash-report"),i.setAttribute("contenteditable","false"),i.append(n,o),i}function createEditor(e,t){e.id||(e.id="editor"+Math.floor(1e4*Math.random())),(t=Object.assign({},t)).selector="#"+e.id,tinyMCE.init(t)}function destroyEditor(e){e.each(function(){tinyMCE.remove("#"+this.id)})}function getEditorContents(e){return tinyMCE.triggerSave(),e.val()}!function(e){e.fn.areYouSure=function(t){var n=e.extend({message:"You have unsaved changes!",dirtyClass:"dirty",change:null,silent:!1,addRemoveFieldsMarksDirty:!1,fieldEvents:"change keyup propertychange input",fieldSelector:":input:not(input[type=submit]):not(input[type=button])"},t),o=function(t){if(t.hasClass("ays-ignore")||t.hasClass("aysIgnore")||t.attr("data-ays-ignore")||void 0===t.attr("name"))return null;if(t.is(":disabled"))return"ays-disabled";var n,o=t.attr("type");switch(t.is("select")&&(o="select"),o){case"checkbox":case"radio":n=t.is(":checked");break;case"select":n="",t.find("option").each(function(){var t=e(this);t.is(":selected")&&(n+=t.val())});break;default:n=t.val()}return n},i=function(e){e.data("ays-orig",o(e))},a=function(t){var i=function(e){var t=e.data("ays-orig");return void 0!==t&&o(e)!=t},a=e(this).is("form")?e(this):e(this).parents("form");if(i(e(t.target)))s(a,!0);else{var r=a.find(n.fieldSelector);if(n.addRemoveFieldsMarksDirty&&a.data("ays-orig-field-count")!=r.length)return void s(a,!0);var l=!1;r.each(function(){var t=e(this);if(i(t))return l=!0,!1}),s(a,l)}},r=function(t){var o=t.find(n.fieldSelector);e(o).each(function(){i(e(this))}),e(o).unbind(n.fieldEvents,a),e(o).bind(n.fieldEvents,a),t.data("ays-orig-field-count",e(o).length),s(t,!1)},s=function(e,t){var o=t!=e.hasClass(n.dirtyClass);e.toggleClass(n.dirtyClass,t),o&&(n.change&&n.change.call(e,e),t&&e.trigger("dirty.areYouSure",[e]),t||e.trigger("clean.areYouSure",[e]),e.trigger("change.areYouSure",[e]))},l=function(){var t=e(this),o=t.find(n.fieldSelector);e(o).each(function(){var t=e(this);t.data("ays-orig")||(i(t),t.bind(n.fieldEvents,a))}),t.trigger("checkform.areYouSure")},c=function(){r(e(this))};return n.silent||window.aysUnloadSet||(window.aysUnloadSet=!0,e(window).bind("beforeunload",function(){if(0!=e("form").filter("."+n.dirtyClass).length){if(navigator.userAgent.toLowerCase().match(/msie|chrome/)){if(window.aysHasPrompted)return;window.aysHasPrompted=!0,window.setTimeout(function(){window.aysHasPrompted=!1},900)}return n.message}})),this.each(function(){if(e(this).is("form")){var t=e(this);t.submit(function(){t.removeClass(n.dirtyClass)}),t.bind("reset",function(){s(t,!1)}),t.bind("rescan.areYouSure",l),t.bind("reinitialize.areYouSure",c),t.bind("checkform.areYouSure",a),r(t)}})}}(jQuery),R.onDOMLoaded(function(){$("select").each(function(){if(0==$(this).parents(".template").length){var e="noSearch"==$(this).attr("noSearch");$(this).chosen({placeholder_text_multiple:" ",disable_search:e})}}),$("form[name=form1]").areYouSure();for(const e of document.querySelectorAll("[data-opens-dialog]"))e.addEventListener("click",e=>{const t=e.currentTarget.dataset.opensDialog;let n;t&&(n=R.get(t))?n.showModal():console.warn("Failed to find dialog to open",t)});attachSpoilerToggle($(".spoiler-toggle"))}),$(function(){navigator.userAgent.toLowerCase().match(/iphone|ipad|ipod|opera/)&&$("a").bind("click",function(e){var t=$(e.target).closest("a").attr("href");if(void 0!==t&&!t.match(/^#/)&&""!=t.trim()){var n=$(window).triggerHandler("beforeunload",n);return n&&""!=n&&!confirm(n+"\n\nPress OK to leave this page or Cancel to stay.")||(window.location.href=t),!1}})});
//# sourceMappingURL=script.js.map